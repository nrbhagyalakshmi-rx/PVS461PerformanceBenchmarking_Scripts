var currentPriority,changeToPriority;
$(document).ready(function(){$(document).on("click",".changePriority",setPriorityTriggerButton);$(document).on("click",".changeToPriority",setChangeToPriorityTriggerButton);$(document).on("click",".priorityChangeNotAllowed",showNotAllowedNotification);$("#priorityJustificationPopover #edit-box").hide();$("#priorityJustificationPopover .selectJustification").click(function(){initChangePriority($(this).html())});$("#priorityJustificationPopover #addNewJustification, #priorityJustificationPopover .editIcon").on("click",function(b){$(b.target).hasClass("editIcon")&&
$("#priorityJustificationPopover .editedJustification").val($(this).parent().siblings(".selectJustification").html());$("#priorityJustificationPopover #addNewJustification").hide();$("#priorityJustificationPopover #edit-box").show();priorityEditPadding()});$("#priorityJustificationPopover #confirmJustification").on("click",function(){initChangePriority($("#priorityJustificationPopover .editedJustification").val())});$("#priorityJustificationPopover").on("hide.bs.modal",function(){changeToPriority=
currentPriority=void 0;clearAndHidePriorityJustificationEditBox()});$("#priorityJustificationPopover").on("shown.bs.modal",function(){$("#priorityJustificationPopover .popover-content").scrollTop(0);$("a:visible:first",this).focus()});$("#priorityJustificationPopover #cancelJustification").on("click",function(){clearAndHidePriorityJustificationEditBox()});$("#priorityPopover").on("shown.bs.modal",function(){$("a:visible:first",this).focus()})});
var showNotAllowedNotification=function(){$.Notification.notify("warning","top right","Warning","You don't have access to change the priority for this product.",{autoHideDelay:2E4})},clearAndHidePriorityJustificationEditBox=function(){$("#priorityJustificationPopover #edit-box").hide();$("#priorityJustificationPopover .editedJustification").val("");$("#priorityJustificationPopover #addNewJustification").show();priorityEditPadding()},setPriorityJustificationPopOverTitle=function(){var b=$(currentPriority).parent().attr("title"),
a=$(changeToPriority).parent().data("priority"),b="Priority Change from "+b+" to "+a;$("#priorityJustificationPopover .popover-title").html(b)},setPriorityTriggerButton=function(b){currentPriority=$(b.target);$("#priorityPopover ."+$(currentPriority).attr("class").split(" ").join(".")).parent().hide();$("#priorityPopover :not(."+$(currentPriority).attr("class").split(" ").join(".")+")").parent().show()},setChangeToPriorityTriggerButton=function(b){changeToPriority=$(b.target);forceJustification?setPriorityJustificationPopOverTitle():
initChangePriority()},initChangePriority=function(b){var a;a=$("#detailed-view-checkbox").is(":checked")?$("table#alertsDetailsTable .copy-select:checked").length:$("table.DTFC_Cloned .copy-select:checked").length;1<a&&$(currentPriority).closest("tr").find(".copy-select").prop("checked")?priorityBulkUpdate(a,b):(a=$(currentPriority).closest("tr").index(),isAbstractViewOrCaseView(a)&&(a/=2),a=populatePriorityChangeData(a),changePriority(b,a,!1))},changePriority=function(b,a,c){a["newPriority.id"]=
$(changeToPriority).parent().data("id");b&&(a.justification=b);var d=$(currentPriority).closest("td"),e;$.ajax({url:changePriorityUrl,type:"POST",data:a,dataType:"json",beforeSend:function(){d.is("td")||(d=$(currentPriority).closest("span"));e=$(d).html();c?$.each($(".copy-select:checked"),function(){$(this).closest("td").siblings("td.priorityParent").html("<i id='priorityChangeProcessing' class='mdi mdi-spin mdi-loading'></i>")}):$(d).html("<i id='priorityChangeProcessing' class='mdi mdi-spin mdi-loading'></i>")},
success:function(b){if(b.status){e=signal.utils.render("priority",{priorityValue:$(changeToPriority).parent().data("priority"),priorityClass:$(changeToPriority).attr("class"),isPriorityChangeAllowed:!0});if(c){var g=new Set;$.each($(".copy-select:checked"),function(){$(this).closest("td").siblings("td.priorityParent").html(e);var a=$(this).closest("tr").index();isAbstractViewOrCaseView(a)&&(a/=2);g.add(a)});updateDueIn(g)}else $(d).html(e),b=$(d).closest("tr").index(),isAbstractViewOrCaseView(b)&&
(b/=2),updateDueIn([b]);$.Notification.notify("success","top right","Success","Priority changed successfully.",{autoHideDelay:1E4});applicationLabel==APPLICATION_NAME.CASE_DETAIL&&$("#caseHistoryModalTable").DataTable().ajax.reload();applicationLabel==APPLICATION_LABEL.EVENT_DETAIL&&($("#currentAlertHistoryModalTable").DataTable().ajax.reload(),$("#evdasHistoryModalTable").DataTable().ajax.reload());$("#priority").val(a["newPriority.id"])}else c?table.columns.adjust().draw():$(d).html(e),$.Notification.notify("error",
"top right","Error","Sorry we could not proceed with the request. Kindly contact the administrator.",{autoHideDelay:1E4});$("#priorityJustificationPopover").modalPopover("hide");$("#priorityPopover").modalPopover("hide")},error:function(){d&&$(d).html(e);$.Notification.notify("error","top right","Error","Sorry we could not proceed with the request. Kindly contact the administrator.",{autoHideDelay:1E4});table.columns.adjust().draw()}})},priorityBulkUpdate=function(b,a){var c;switch(applicationName){case "Single Case Alert":c=
"Case";break;case "Aggregate Case Alert":c="PEC";break;case "EVDAS Alert":c="PEC";break;case "Ad-Hoc Alert":c="Observation";break;case "Literature Search Alert":c="Article"}bootbox.dialog({title:"Apply To All",message:signal.utils.render("bulk_operation_options",{totalSelectedRecords:b,alertType:c}),buttons:{ok:{label:"Ok",className:"btn btn-primary",callback:function(){switch($("input[name=bulkOptions]:checked").val()){case "current":var b=populatePriorityChangeData($(currentPriority).closest("tr").index());
changePriority(a,b,!1);break;case "allSelected":checkIfSafetyLeadOfAllSelectedRows()?(b=populatePriorityChangeData($(currentPriority).closest("tr").index(),!0),changePriority(a,b,!0)):$.Notification.notify("error","top right","Error","You must be safety lead for all the selected safety observation for changing the priority",{autoHideDelay:1E4})}}},cancel:{label:"Cancel",className:"btn btn-default"}}})},checkIfSafetyLeadOfAllSelectedRows=function(){var b=!0;$.each($(".copy-select:checked"),function(){$(this).parent().siblings("td.priorityParent").find("a.priorityChangeNotAllowed").length&&
(b=!1)});return b},populatePriorityChangeData=function(b,a){var c={},d=$("#signalIdPartner").val();if(a){var e=new Set,f=[];$.each($("table.DTFC_Cloned .copy-select:checked"),function(){e.add($(this).closest("tr").index())});e.forEach(function(a){f.push(populatePriorityDataFromGrid(a))});c.selectedRows=JSON.stringify(f)}else c.selectedRows=-1<b&&!d?JSON.stringify([populatePriorityDataFromGrid(b)]):JSON.stringify([populatePriorityDataFromOther(d)]);return c},populatePriorityDataFromGrid=function(b){var a=
{};b=table.rows(b).data()[0];a["configObj.id"]=b.alertConfigId;a["executedConfigObj.id"]=b.execConfigId;a["alert.id"]=b.id;return a},populatePriorityDataFromOther=function(b){var a={};a["signal.id"]=b;a["configObj.id"]=$("#configId").html();a["executedConfigObj.id"]=$("#execConfigId").val();a["alert.id"]=$("#alertId").val();return a},priorityEditPadding=function(){var b=$(".popover.priority ul.text-list > li:last-child").height()+11+"px";$(".popover.priority ul.text-list").css("padding-bottom",b);
$(".editedJustification").focus()},updateDueIn=function(b){$("#signalIdPartner").val()||b.forEach(function(a){if(-1<a){var b="table#alertsDetailsTable tr:nth-child("+(a+1)+") td.dueIn";a=new Date(table.rows(a).data()[0].detectedDate);var d=$(changeToPriority).parent().data("days"),e=new Date;a=a.addDays(d).getTime()-e.getTime();a=Math.ceil(a/864E5);$(b).html(signal.list_utils.due_in_comp(a))}})};